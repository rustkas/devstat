name: k6 Baseline Verify

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  k6:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup k6 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      - name: Start DevState Compose
        run: |
          docker compose -f docker-compose.yml up -d
          for i in {1..60}; do
            if curl -fsS http://localhost:3180/health >/dev/null; then echo ready; break; fi; sleep 2; done
      - name: Run k6 verify baseline
        uses: grafana/k6-action@v0.2.0
        with:
          filename: tests/k6/verify.js
          flags: --summary-export=verify-summary.json
      - name: Upload verify summary
        uses: actions/upload-artifact@v4
        with:
          name: k6-verify-summary
          path: |
            verify-summary.json
            verify-summary.html
      - name: Run k6 append baseline
        uses: grafana/k6-action@v0.2.0
        with:
          filename: tests/k6/append.js
          flags: --summary-export=append-summary.json
      - name: Upload append summary
        uses: actions/upload-artifact@v4
        with:
          name: k6-append-summary
          path: |
            append-summary.json
            append-summary.html
      - name: Stop Compose
        run: |
          docker compose -f docker-compose.yml down -v